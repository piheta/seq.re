<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Secret...</title>
    <link rel="stylesheet" href="/static/tailwind.min.css">
    <script src="/static/crypto.js"></script>
    <script src="/static/app.js"></script>
    <link rel="stylesheet" href="/static/viewer-base.css">
</head>

<body class="viewer-container bg-dr-bg-page dark:bg-dr-bg-page-dark text-dr-text dark:text-dr-text-dark">
    <div class="text-center max-w-2xl w-[90%] p-6">
        <div class="viewer-spinner text-dr-purple dark:text-dr-purple-dark mx-auto mb-4"></div>
        <div id="message" class="text-dr-text-gray dark:text-dr-text-gray-light">Decrypting secret...</div>
        <div id="secret-display" class="hidden bg-dr-bg dark:bg-dr-bg-dark rounded-lg p-5 shadow-lg mt-4 text-left break-words whitespace-pre-wrap font-mono text-sm leading-relaxed"></div>
        <button id="copy-button" class="hidden mt-4 px-4 py-2 bg-dr-purple dark:bg-dr-purple-dark text-white rounded-md hover:opacity-90 transition-opacity" onclick="copyDecryptedText('decryptedSecret', 'copy-button')">Copy to Clipboard</button>
    </div>

    <script>
        let decryptedSecret = '';

        // Encrypted secret data embedded in page
        const encryptedData = "{{.Data}}";
        const hash = location.hash.slice(1);

        // Start decryption immediately
        if (!hash) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = 'Error: Encryption key not found in URL';
            messageEl.className = 'text-dr-orange dark:text-dr-orange-dark';
            document.querySelector('.viewer-spinner').style.display = 'none';
        } else {
            importKey(hash)
                .then(key => decrypt(encryptedData, key))
                .then(secret => {
                    decryptedSecret = secret;

                    // Display secret
                    const secretDisplay = document.getElementById('secret-display');
                    secretDisplay.textContent = secret;
                    secretDisplay.classList.remove('hidden');
                    document.getElementById('copy-button').classList.remove('hidden');

                    // Hide spinner and message
                    document.querySelector('.viewer-spinner').style.display = 'none';
                    document.getElementById('message').style.display = 'none';
                })
                .catch(err => {
                    console.error('Decryption error:', err);
                    const messageEl = document.getElementById('message');
                    messageEl.textContent = 'Failed to decrypt secret. The link may be invalid or expired.';
                    messageEl.className = 'text-dr-orange dark:text-dr-orange-dark';
                    document.querySelector('.viewer-spinner').style.display = 'none';
                });
        }
    </script>
</body>

</html>
