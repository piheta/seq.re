<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Image...</title>
    <link rel="stylesheet" href="/static/tailwind.min.css">
    <script src="/static/crypto.js"></script>
    <script src="/static/app.js"></script>
    <link rel="stylesheet" href="/static/viewer-base.css">
</head>

<body class="viewer-container bg-dr-bg-page dark:bg-dr-bg-page-dark text-dr-text dark:text-dr-text-dark">
    <div class="text-center max-w-[90%]">
        <div class="viewer-spinner text-dr-green dark:text-dr-green-dark mx-auto mb-4"></div>
        <div id="message" class="text-dr-text-gray dark:text-dr-text-gray-light">Decrypting image...</div>
        <img id="image-display" alt="Decrypted image" class="hidden max-w-full max-h-[90vh] rounded-lg shadow-lg mt-4">
    </div>

    <script>
        // Encrypted image data embedded in page
        const encryptedData = "{{.Data}}";
        const hash = location.hash.slice(1);

        // Start decryption immediately
        if (!hash) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = 'Error: Encryption key not found in URL';
            messageEl.className = 'text-dr-orange dark:text-dr-orange-dark max-w-md mx-auto';
            document.querySelector('.viewer-spinner').style.display = 'none';
        } else {
            importKey(hash)
                .then(key => {
                    const encryptedBytes = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
                    return decryptFile(encryptedBytes, key);
                })
                .then(decryptedData => {
                    // Create blob from decrypted data
                    const blob = new Blob([decryptedData]);
                    const url = URL.createObjectURL(blob);

                    // Display image
                    const img = document.getElementById('image-display');
                    img.src = url;
                    img.classList.remove('hidden');

                    // Hide spinner and message
                    document.querySelector('.viewer-spinner').style.display = 'none';
                    document.getElementById('message').style.display = 'none';
                })
                .catch(err => {
                    console.error('Decryption error:', err);
                    const messageEl = document.getElementById('message');
                    messageEl.textContent = 'Failed to decrypt image. The link may be invalid or expired.';
                    messageEl.className = 'text-dr-orange dark:text-dr-orange-dark max-w-md mx-auto';
                    document.querySelector('.viewer-spinner').style.display = 'none';
                });
        }
    </script>
</body>

</html>
