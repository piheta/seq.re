<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decrypting Image...</title>
    <link rel="stylesheet" href="/static/tailwind.min.css">
    <script src="/static/crypto.js"></script>
    <script src="/static/app.js"></script>
    <style>
        body {
            color-scheme: light;
        }

        .dark body {
            color-scheme: dark !important;
        }

        #content {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        img {
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }
    </style>
</head>

<body class="min-h-screen bg-dr-bg-page dark:bg-dr-bg-page-dark">
    <div id="content" class="text-dr-text-heading dark:text-dr-text-heading-dark">Decrypting image...</div>

    <script>
        (async function () {
            try {
                const encryptedData = "{{.Data}}";
                const encryptionKey = location.hash.slice(1);

                if (!encryptionKey) {
                    throw new Error("No encryption key provided");
                }

                const cryptoKey = await importKey(encryptionKey);
                const encryptedBytes = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
                const decryptedBytes = await decryptFile(encryptedBytes, cryptoKey);

                // Create blob and display image
                const blob = new Blob([decryptedBytes], {type: '{{.ContentType}}'});
                const blobUrl = URL.createObjectURL(blob);

                const img = document.createElement('img');
                img.src = blobUrl;
                img.alt = 'Decrypted image';

                const contentDiv = document.getElementById('content');
                contentDiv.innerHTML = '';
                contentDiv.appendChild(img);
            } catch (err) {
                console.error('Decryption failed:', err);
                document.getElementById('content').innerHTML = '<div class="text-dr-orange dark:text-dr-orange-dark text-center p-5">Failed to decrypt image.<br>The encryption key may be invalid or missing.</div>';
            }
        })();
    </script>
</body>

</html>
