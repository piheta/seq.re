<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Paste...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/tailwind.config.js"></script>
    <script src="/static/crypto.js"></script>
    <script src="/static/app.js"></script>
    <link rel="stylesheet" href="/static/viewer-base.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body class="m-0 bg-[#0d1117] text-[#c9d1d9]">
    <div class="paste-viewer">
        <div class="flex flex-col items-center justify-center min-h-[50vh]">
            <div class="viewer-spinner text-dr-orange dark:text-dr-orange-dark mb-4"></div>
            <div id="message" class="text-dr-text-gray-light">Decrypting paste...</div>
        </div>

        <div id="paste-display" class="hidden">
            <div class="paste-header bg-[#161b22]">
                <div>
                    <span id="language-badge" class="hidden inline-block px-3 py-1 bg-dr-orange dark:bg-dr-orange-dark text-white rounded-full text-xs font-medium"></span>
                </div>
                <button id="copy-paste-button" class="px-4 py-2 bg-dr-green dark:bg-dr-green-dark text-white rounded-md hover:opacity-90 transition-opacity" onclick="copyDecryptedText('decryptedContent', 'copy-paste-button')">Copy</button>
            </div>
            <pre class="m-0 p-0 bg-[#0d1117]"><code id="code-display" class="paste-code bg-[#161b22] border border-[#30363d]"></code></pre>
        </div>
    </div>

    <script>
        let decryptedContent = '';

        // Encrypted paste data embedded in page
        const encryptedData = "{{.Data}}";
        const language = "{{.Language}}";
        const hash = location.hash.slice(1);

        // Start decryption immediately
        if (!hash) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = 'Error: Encryption key not found in URL';
            messageEl.className = 'text-dr-orange dark:text-dr-orange-dark text-center';
            document.querySelector('.viewer-spinner').style.display = 'none';
        } else {
            importKey(hash)
                .then(key => decrypt(encryptedData, key))
                .then(content => {
                    decryptedContent = content;

                    // Display paste
                    const codeElement = document.getElementById('code-display');
                    codeElement.textContent = content;

                    // Apply syntax highlighting if language is specified
                    if (language && language !== '') {
                        const languageBadge = document.getElementById('language-badge');
                        languageBadge.textContent = language;
                        languageBadge.classList.remove('hidden');

                        codeElement.classList.add('language-' + language);
                        hljs.highlightElement(codeElement);
                    } else {
                        codeElement.classList.add('plain-text');
                    }

                    // Show paste, hide spinner
                    document.getElementById('paste-display').classList.remove('hidden');
                    document.querySelector('.viewer-spinner').parentElement.style.display = 'none';
                    document.title = 'Paste';
                })
                .catch(err => {
                    console.error('Decryption error:', err);
                    const messageEl = document.getElementById('message');
                    messageEl.textContent = 'Failed to decrypt paste. The link may be invalid or expired.';
                    messageEl.className = 'text-dr-orange dark:text-dr-orange-dark text-center';
                    document.querySelector('.viewer-spinner').style.display = 'none';
                });
        }
    </script>
</body>

</html>
