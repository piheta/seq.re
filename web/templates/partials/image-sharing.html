<div class="space-y-4">
    <div class="flex items-center gap-2 mb-4">
        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        <h2 class="text-gray-900">Image Sharing</h2>
    </div>

    <label
        id="drop-zone"
        class="flex items-center justify-center w-full px-4 py-8 border-2 border-dashed border-gray-300 rounded-md cursor-pointer hover:border-green-500 transition-colors"
        ondrop="handleDrop(event)"
        ondragover="handleDragOver(event)"
        ondragleave="handleDragLeave(event)"
    >
        <div class="text-center">
            <svg class="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
            <span class="text-gray-600" id="file-label">Click or drag image here</span>
        </div>
        <input
            id="image-input"
            type="file"
            name="image"
            accept="image/*"
            class="hidden"
            onchange="handleFileSelect(this)"
        />
    </label>

        <!-- Options -->
        <div class="space-y-2 mt-4">
            <label class="flex items-center gap-2 cursor-pointer">
                <input
                    type="radio"
                    name="mode"
                    value="public"
                    checked
                    class="w-4 h-4 text-green-600 focus:ring-green-500"
                    onchange="resetImageUpload()"
                />
                <span class="text-gray-700">Public</span>
            </label>

            <label class="flex items-center gap-2 cursor-pointer">
                <input
                    type="radio"
                    name="mode"
                    value="encrypted"
                    class="w-4 h-4 text-green-600 focus:ring-green-500"
                    onchange="resetImageUpload()"
                />
                <span class="text-gray-700">Encrypted</span>
            </label>

            <label class="flex items-center gap-2 cursor-pointer">
                <input
                    id="image-onetime-checkbox"
                    type="checkbox"
                    name="self_destruct"
                    value="true"
                    checked
                    class="w-4 h-4 text-green-600 focus:ring-green-500 rounded"
                    onchange="resetImageUpload()"
                />
                <span class="text-gray-700">One-time</span>
            </label>
        </div>

    <!-- Image Preview -->
    <div id="image-preview" class="hidden mt-4">
        <img id="preview-img" class="w-full max-h-80 object-contain rounded-md border border-gray-300" alt="Preview">
    </div>

    <div id="image-result"></div>
</div>

<script>
function resetImageUpload() {
    // Hide preview and result
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('image-result').innerHTML = '';

    // Reset file input and label
    const fileInput = document.getElementById('image-input');
    fileInput.value = '';
    document.getElementById('file-label').textContent = 'Click or drag image here';
}

function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropZone = document.getElementById('drop-zone');
    dropZone.classList.add('border-green-500', 'bg-green-50');
}

function handleDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropZone = document.getElementById('drop-zone');
    dropZone.classList.remove('border-green-500', 'bg-green-50');
}

function handleDrop(event) {
    event.preventDefault();
    event.stopPropagation();

    const dropZone = document.getElementById('drop-zone');
    dropZone.classList.remove('border-green-500', 'bg-green-50');

    const files = event.dataTransfer.files;
    if (files && files[0]) {
        // Check if it's an image
        if (files[0].type.startsWith('image/')) {
            processFile(files[0]);
        } else {
            document.getElementById('image-result').innerHTML = '<div class="text-red-600 mt-4">Please drop an image file</div>';
        }
    }
}

async function handleFileSelect(input) {
    if (!input.files || !input.files[0]) {
        return;
    }

    await processFile(input.files[0]);
}

async function processFile(file) {
    document.getElementById('file-label').textContent = file.name;

    // Show preview
    const previewDiv = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');

    const reader = new FileReader();
    reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewDiv.classList.remove('hidden');
    };
    reader.readAsDataURL(file);

    // Auto-upload after showing preview
    await uploadImage(file);
}

async function uploadImage(file) {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const onetime = document.getElementById('image-onetime-checkbox').checked;
    const resultDiv = document.getElementById('image-result');

    const encrypted = mode === 'encrypted';

    try {
        resultDiv.innerHTML = '<div class="text-gray-600 mt-4">Uploading...</div>';

        let imageURL;

        if (encrypted) {
            // Generate encryption key
            const key = await generateKey();

            // Read file as ArrayBuffer
            const fileData = await file.arrayBuffer();

            // Encrypt the file
            const encryptedData = await encryptFile(new Uint8Array(fileData), key);

            // Create FormData with encrypted blob
            const formData = new FormData();
            formData.append('file', new Blob([encryptedData]), 'encrypted.bin');
            formData.append('encrypted', 'true');
            if (onetime) {
                formData.append('onetime', 'true');
            }

            // Upload to API
            const response = await fetch('/api/images', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to upload image');
            }

            imageURL = await response.json();

            // Append key fragment to URL
            const keyFragment = await exportKey(key);
            imageURL = imageURL + '#' + keyFragment;
        } else {
            // Create FormData with plain file
            const formData = new FormData();
            formData.append('file', file);
            if (onetime) {
                formData.append('onetime', 'true');
            }

            // Upload to API
            const response = await fetch('/api/images', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to upload image');
            }

            imageURL = await response.json();
        }

        // Display result
        const warningText = onetime ? '<p class="text-sm text-gray-500 mt-2">⚠️ This link will self-destruct after being viewed once.</p>' : '';

        resultDiv.innerHTML = `
            <div class="flex gap-2 items-center mt-4">
                <input
                    type="text"
                    value="${imageURL}"
                    readonly
                    class="flex-1 px-4 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-700"
                />
                <button
                    onclick="copyToClipboard('${imageURL}', 'copy-btn-image')"
                    id="copy-btn-image"
                    class="p-2 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors"
                >
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </button>
            </div>
            ${warningText}
        `;

        // Reset file input (but keep preview visible)
        const fileInput = document.getElementById('image-input');
        fileInput.value = '';
        document.getElementById('file-label').textContent = 'Click to select image';
    } catch (error) {
        resultDiv.innerHTML = `<div class="text-red-600 mt-4">Error: ${error.message}</div>`;
    }
}
</script>
